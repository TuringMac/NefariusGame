<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Тест</title>
    <script src="js/signalr.min.js"></script>
    <script>
        let hubUrl = localStorage.getItem('hubUrl') || '/game';

        let hubConnection = new signalR.HubConnection(hubUrl);

        hubConnection.start();

        hubConnection.on("PlayerData", function (data) {
            document.getElementById('name').innerHTML = JSON.stringify(data.name);
            document.getElementById('money').innerHTML = JSON.stringify(data.coins);
            document.getElementById('score').innerHTML = JSON.stringify(data.score);
            renderInventions(data.inventions);
            document.getElementById('player').innerHTML = JSON.stringify(data);
            document.getElementById('currEff').innerHTML = (data.currentEffect) ? (data.currentEffect.direction + ' ' + data.currentEffect.count + ' ' + data.currentEffect.item) : 'none';
            //document.getElementById('inv').innerHTML = JSON.stringify(data.inventions);
        });

        hubConnection.on("StateChanged", function (data) {
            document.getElementById('game').innerHTML = JSON.stringify(data);
            renderState(data);
        });

        hubConnection.onclose(e => {
            alert(e);
        });

        function renderState(data) {
            for (var i = 0; i < 10; i++) {
                document.getElementById('state' + i).style = 'background-color:white';
            }
            document.getElementById('state' + data.state).style = 'background-color:yellow';
        }

        function renderInventions(invArr) {
            var cardsHtml = '<table><tr>';
            for (var i = 0; i < invArr.length; i++) {
                var id = invArr[i].id,
                    cost = invArr[i].cost,
                    score = invArr[i].score,
                    self = invArr[i].selfEffectList,
                    other = invArr[i].otherEffectList;

                cardsHtml += '<td><table border="1"><tr><td>$' + cost + ' <b>' + score + '</b></td></tr><tr><td>' + self + '</td></tr><tr><td>' + other + '</td></tr><tr><td><input type="button" value="Play" onclick="hubConnection.invoke(\'Invent\',' + id + ')"></td></tr></table></td>';
            }
            cardsHtml += '</tr></table>';
            document.getElementById('inventions').innerHTML = cardsHtml;

            //<table>
            //    <tr>
            //        <td><div>Cost</div><div>Score</div></td>
            //    </tr>
            //    <tr>
            //        <td>Self</td>
            //    </tr>
            //    <tr>
            //        <td>Other</td>
            //    </tr>
            //    <tr>
            //        <td><input type="button" value="Play" onclick="hubConnection.invoke('Invent',id)"></td>
            //    </tr>
            //</table>
        }
    </script>
</head>
<body>
    <table>
        <caption><b>Game</b></caption>
        <thead>
            <tr>
                <td><b>State</b></td>
                <td colspan="9"><b>Actions</b></td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><b>Game</b></td>
                <td><input type="button" value="Begin" onclick="hubConnection.invoke('Begin')"></td>
                <td><input type="button" value="End" onclick="hubConnection.invoke('End')"></td>
            </tr>
            <tr>
                <td><b>Player</b></td>
                <td>Name</td>
                <td id="name"></td>
                <td>Score</td>
                <td id="score"></td>
                <td>Coins</td>
                <td id="money"></td>
                <td><input type="button" value="Leave" onclick="hubConnection.invoke('Leave')"></td>
            </tr>
            <tr id="state0">
                <td>0 Join</td>
                <td><input type="button" value="Player 1" onclick="hubConnection.invoke('Join', 'Player 1')"></td>
                <td><input type="button" value="Player 2" onclick="hubConnection.invoke('Join', 'Player 2')"></td>
                <td><input type="button" value="Player 3" onclick="hubConnection.invoke('Join', 'Player 3')"></td>
                <td><input type="button" value="Player 4" onclick="hubConnection.invoke('Join', 'Player 4')"></td>
                <td><input type="button" value="Player 5" onclick="hubConnection.invoke('Join', 'Player 5')"></td>
                <td><input type="button" value="Player 6" onclick="hubConnection.invoke('Join', 'Player 6')"></td>
            </tr>
            <tr id="state1">
                <td>1 Turn</td>
                <td><input type="button" value="Отменить ход" onclick="hubConnection.invoke('Turn', 0)"></td>
                <td><input type="button" value="Spy" onclick="hubConnection.invoke('Turn', 1)"></td>
                <td><input type="button" value="Invent" onclick="hubConnection.invoke('Turn', 2)"></td>
                <td><input type="button" value="Research" onclick="hubConnection.invoke('Turn', 3)"></td>
                <td><input type="button" value="Work" onclick="hubConnection.invoke('Turn', 4)"></td>
            </tr>
            <tr id="state2">
                <td>2 Spying</td>
                <td colspan="9">Game count coins for spying</td>
            </tr>
            <tr id="state3">
                <td>3 Spy</td>
                <td>
                    <input type="button" value="To Spy" onclick="hubConnection.invoke('Spy', 1, 0)"><br />
                    <input type="button" value="From Spy" onclick="hubConnection.invoke('Spy', 0, 1)">
                </td>
                <td>
                    <input type="button" value="To Invent $2" onclick="hubConnection.invoke('Spy', 2, 0)"><br />
                    <input type="button" value="From Invent" onclick="hubConnection.invoke('Spy', 0, 2)">
                </td>
                <td>
                    <input type="button" value="To Research" onclick="hubConnection.invoke('Spy', 3, 0)"><br />
                    <input type="button" value="From Research" onclick="hubConnection.invoke('Spy', 0, 3)">
                </td>
                <td>
                    <input type="button" value="To Work $1" onclick="hubConnection.invoke('Spy', 4, 0)"><br />
                    <input type="button" value="From Work" onclick="hubConnection.invoke('Spy', 0, 4)">
                </td>
            </tr>
            <tr id="state4">
                <td>4 Invent</td>
                <td id="inventions" colspan="9">List of inventions with scroll</td>
            </tr>
            <tr id="state5">
                <td>5 Inventing</td>
                <td colspan="9"><div id="currEff">Current effect here</div></td>
            </tr>
            <tr id="state6">
                <td>6 Researching</td>
                <td colspan="9">Just get invention and coins</td>
            </tr>
            <tr id="state7">
                <td>7 Working</td>
                <td colspan="9">Get some coins</td>
            </tr>
            <tr id="state8">
                <td>8 Scoring</td>
                <td colspan="9">Check player's score</td>
            </tr>
            <tr id="state9">
                <td>9 Win</td>
                <td colspan="9">Winner is: hmmm...</td>
            </tr>
        </tbody>
    </table>
    <br />
    <h3>Игра</h3><br />
    <p id="game"></p><br />
    <h3>Игрок</h3><br />
    <p id="player"></p><br />
</body>
</html>